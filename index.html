<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carregando Loja...</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #1E90FF; --dark-bg: #121212; --card-bg: #1e1e1e;
      --text-color: #ffffff; --success-color: #25D366; --danger-color: #ff4444;
      --gray-color: #333333; --light-gray: #555555; --discount-color: #9C27B0;
      --category-color: #FF5722;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background-color: var(--dark-bg); color: var(--text-color); font-family: 'Segoe UI', sans-serif; line-height: 1.6; padding-top: 80px; padding-bottom: 100px; }
    .container { max-width: 800px; margin: 0 auto; padding: 0 1rem; }
    .floating-cart { position: fixed; top: 0; left: 0; right: 0; background: var(--card-bg); padding: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary-color); }
    .cart-summary { display: flex; align-items: center; gap: 1rem; }
    .cart-toggle { background: var(--primary-color); color: black; border: none; padding: 0.5rem 1rem; border-radius: 30px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 0.5rem; }
    .cart-count { background: black; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
    .cart-dropdown { position: absolute; top: 100%; right: 1rem; background: var(--card-bg); width: 350px; max-height: 70vh; overflow-y: auto; border-radius: 0 0 10px 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); padding: 1rem; display: none; }
    .cart-dropdown.show { display: block; animation: fadeIn 0.3s ease; }
    .cart-item { margin: 0.5rem 0; padding: 0.8rem; background: var(--dark-bg); border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
    .empty-cart { text-align: center; padding: 1rem; color: var(--light-gray); }
    .hidden { display: none; }
    .btn { display: inline-block; padding: 0.8rem 1.5rem; border-radius: 30px; font-weight: bold; cursor: pointer; border: none; text-align: center; }
    .btn-primary { background: var(--primary-color); color: #000; }
    .btn-success { background: var(--success-color); color: white; }
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
    .product-card { background: var(--card-bg); padding: 1.2rem; border-radius: 10px; cursor: pointer; transition: transform 0.3s ease; border-left: 4px solid var(--primary-color); }
    .product-card:hover { transform: translateY(-5px); }
    .product-card i { font-size: 1.8rem; margin-bottom: 1rem; color: var(--primary-color); }
    .variation-btn { display: block; width: 100%; background: var(--gray-color); padding: 0.8rem; margin: 0.5rem 0; border-radius: 8px; cursor: pointer; text-align: left;}
    .variation-btn.active { background: var(--primary-color); color: black; font-weight: bold; }
    .top-back-link, .back-link { color: var(--primary-color); cursor: pointer; display: inline-block; margin: 1rem 0; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>
    <div class="floating-cart">
        <div class="cart-summary">
            <i class="fas fa-shopping-cart"></i>
            <span>Carrinho (<span id="cart-count">0</span>)</span>
        </div>
        <button class="cart-toggle" onclick="toggleCart()">
            <span>Ver Carrinho</span>
            <div class="cart-count" id="cart-badge">0</div>
        </button>
        <div class="cart-dropdown" id="cartDropdown">
            <h3>Seu Carrinho</h3>
            <div id="cart-items"><p class="empty-cart">Seu carrinho está vazio.</p></div>
            <div class="cart-total" style="margin-top: 1rem;">Total: <span id="cart-total">R$ 0,00</span></div>
            <button class="btn btn-success" style="width: 100%; margin-top: 1rem;" onclick="checkout()">Finalizar Pedido</button>
        </div>
    </div>

    <div class="container" id="main-container">
        </div>

  <script>
    let cart = [];
    let products = [];
    let settings = {};
    let selectedProductId = null;
    let selectedVariationText = "";

    // --- Funções Auxiliares ---
    function formatPrice(price) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(price); }
    function loadCart() { const savedCart = localStorage.getItem('trocoTVCart'); if (savedCart) cart = JSON.parse(savedCart); }
    function saveCart() { localStorage.setItem('trocoTVCart', JSON.stringify(cart)); }
    function toggleCart() { document.getElementById("cartDropdown").classList.toggle("show"); }

    // --- Lógica de Navegação ---
    function handleLocation() {
        const hash = window.location.hash;
        if (hash.startsWith('#produto/')) {
            renderProductPage(parseInt(hash.split('/')[1]));
        } else {
            renderHomePage();
        }
    }
    function navigateToProduct(id) {
        history.pushState({ productId: id }, '', `#produto/${id}`);
        handleLocation();
    }
    function goHome() {
        history.pushState({ productId: null }, '', window.location.pathname);
        handleLocation();
    }
    window.addEventListener('popstate', handleLocation);

    // --- Renderização da UI ---
    function renderHomePage() {
        const container = document.getElementById('main-container');
        container.innerHTML = `
            <div id="homePage">
              <header style="text-align: center; margin-bottom: 2rem;">
                <h1 id="site-title" style="color: var(--primary-color);"></h1>
                <p id="site-tagline"></p>
              </header>
              <div id="productsByCategory"></div>
            </div>`;
        
        document.getElementById("site-title").innerHTML = `<i class="fas fa-tv"></i> ${settings.title}`;
        document.getElementById("site-tagline").textContent = settings.tagline;
        renderProducts();
    }
    
    function renderProducts() {
        const container = document.getElementById('productsByCategory');
        let content = '<div class="product-grid">';
        products.forEach(product => {
            const minPrice = Math.min(...product.variations.map(v => v.price));
            content += `
                <div class="product-card" onclick="navigateToProduct(${product.id})">
                  <i class="${product.icon}"></i>
                  <h3>${product.name}</h3>
                  <p>${product.description}</p>
                  <div style="margin-top: 0.5rem;"><strong>A partir de ${formatPrice(minPrice)}</strong></div>
                </div>`;
        });
        content += '</div>';
        container.innerHTML = content;
    }

    function renderProductPage(id) {
        const product = products.find(p => p.id === id);
        if (!product) { goHome(); return; }

        selectedProductId = id;
        const container = document.getElementById('main-container');
        container.innerHTML = `
            <div id="productDetail">
              <a class="top-back-link" onclick="goHome()"><i class="fas fa-arrow-left"></i> Voltar</a>
              <div style="background: var(--card-bg); padding: 1.2rem; border-radius: 10px; margin: 1rem 0;">
                <h2><i class="${product.icon}"></i> ${product.name}</h2>
                <p>${product.description}</p>
                <h3>Opções:</h3>
                <div id="variationsContainer"></div>
                <button class="btn btn-primary" style="margin-top: 1rem;" onclick="addToCart()">Adicionar ao Carrinho</button>
              </div>
            </div>`;
            
        const variationsContainer = document.getElementById("variationsContainer");
        product.variations.forEach((variation, index) => {
            const btn = document.createElement('button');
            btn.className = 'variation-btn';
            if (index === 0) {
                btn.classList.add('active');
                selectedVariationText = variation.name;
            }
            btn.innerHTML = `<strong>${variation.name}</strong><br><small>${formatPrice(variation.price)} - ${variation.details}</small>`;
            btn.onclick = () => selectVariation(btn, variation.name);
            variationsContainer.appendChild(btn);
        });
        window.scrollTo(0, 0);
    }
    
    function selectVariation(element, variationName) {
        document.querySelectorAll(".variation-btn").forEach(b => b.classList.remove("active"));
        element.classList.add("active");
        selectedVariationText = variationName;
    }

    // --- Lógica do Carrinho ---
    function addToCart() {
        if (!selectedProductId || !selectedVariationText) { alert("Selecione uma opção."); return; }
        const product = products.find(p => p.id === selectedProductId);
        const variation = product.variations.find(v => v.name === selectedVariationText);
        
        const existingItem = cart.find(item => item.productId === product.id && item.variation === variation.name);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ productId: product.id, name: product.name, variation: variation.name, price: variation.price, quantity: 1, icon: product.icon });
        }
        saveCart();
        updateCart();
        alert(`${variation.name} adicionado ao carrinho!`);
    }

    function updateCart() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById("cart-count").textContent = totalItems;
        document.getElementById("cart-badge").textContent = totalItems;
        
        const cartItemsEl = document.getElementById("cart-items");
        const cartTotalEl = document.getElementById("cart-total");
        
        if (cart.length === 0) {
            cartItemsEl.innerHTML = '<p class="empty-cart">Seu carrinho está vazio.</p>';
            cartTotalEl.textContent = formatPrice(0);
            return;
        }
        
        let content = '';
        let total = 0;
        cart.forEach(item => {
            total += item.price * item.quantity;
            content += `<div class="cart-item"><span>${item.quantity}x ${item.name} (${item.variation})</span> <span>${formatPrice(item.price * item.quantity)}</span></div>`;
        });
        
        cartItemsEl.innerHTML = content;
        cartTotalEl.textContent = formatPrice(total);
    }

    function checkout() {
        if (cart.length === 0) { alert("Seu carrinho está vazio."); return; }
        let total = 0;
        let itemsText = cart.map(item => {
            total += item.price * item.quantity;
            return `*${item.name} - ${item.variation}* (Qtd: ${item.quantity}) - ${formatPrice(item.price * item.quantity)}`;
        }).join("\n\n");
        
        let message = `Olá, gostaria de adquirir os seguintes planos:\n\n${itemsText}\n\n*Total: ${formatPrice(total)}*\n\nAguardo as instruções.`;
        if (settings.links?.support_whatsapp_number) {
            window.open(`https://wa.me/${settings.links.support_whatsapp_number}?text=${encodeURIComponent(message)}`, "_blank");
        }
    }

    // --- Inicialização ---
    async function init() {
        try {
            // **MUDANÇA IMPORTANTE: Carrega os dados da pasta /data/**
            const settingsPromise = fetch('/data/settings.json?v=' + Date.now()).then(res => res.json());
            const productsPromise = fetch('/data/products.json?v=' + Date.now()).then(res => res.json());
            
            const [settingsResponse, productsResponse] = await Promise.all([settingsPromise, productsPromise]);
            
            settings = settingsResponse;
            products = productsResponse.items || [];
            
            document.title = settings.title || "Loja";
            
            loadCart();
            updateCart();
            handleLocation();

        } catch (error) {
            console.error("Erro fatal ao carregar:", error);
            document.getElementById('main-container').innerHTML = `<h1 style='color: var(--danger-color); text-align: center; margin-top: 2rem;'>Erro ao carregar a loja.</h1><p style='color: var(--light-gray); text-align: center;'>Verifique se a pasta foi renomeada para "data" e publicada.</p>`;
        }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>